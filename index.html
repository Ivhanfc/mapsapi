<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro con Twilio y Firebase</title>
    <style>
        /* Estilos anteriores se mantienen igual */
    </style>
</head>
<body>
    <!-- Contenido HTML anterior se mantiene igual -->

    <!-- Elemento oculto para comunicación con App Inventor -->
    <div id="appInventorComms" style="display:none;"></div>

    <script>
        // =============================================
        // Configuración Inicial
        // =============================================
        
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBbR-O6hqk9gN2ohQuCCmV-vHiaEGhAL8s",
            authDomain: "construyecercadeti.firebaseapp.com",
            databaseURL: "https://construyecercadeti-default-rtdb.firebaseio.com",
            projectId: "construyecercadeti",
            storageBucket: "construyecercadeti.appspot.com",
            messagingSenderId: "888808949632",
            appId: "1:888808949632:web:677961b72573979c1b6365",
            measurementId: "G-METG6NS3ZC"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Datos del usuario
        let usuario = {
            nombre: '',
            telefono: '',
            password: '',
            verificationId: ''
        };

        // =============================================
        // Comunicación con App Inventor
        // =============================================

        // Función para detectar si estamos en App Inventor
        function isAppInventor() {
            return navigator.userAgent.includes('AppInventor');
        }

        // Función para enviar mensajes
        function sendToAppInventor(data) {
            if (isAppInventor()) {
                // Método para App Inventor
                const commsElement = document.getElementById('appInventorComms');
                commsElement.setAttribute('data-message', JSON.stringify(data));
                commsElement.textContent = Date.now().toString(); // Forzar cambio
            } else {
                // Método para navegador normal
                console.log("Mensaje para App Inventor:", data);
            }
        }

        // Función para recibir mensajes de App Inventor
        window.receiveFromApp = function(data) {
            console.log("Datos recibidos de App Inventor:", data);
            if (data.telefono) {
                document.getElementById('telefono').value = data.telefono;
            }
        };

        // =============================================
        // Funciones de la Aplicación
        // =============================================

        // Función para mostrar estado
        function showStatus(message, isError = false) {
            const statusElement = document.getElementById("status");
            statusElement.innerText = message;
            statusElement.className = isError ? "error" : "success";
            sendToAppInventor({ type: "status", message, isError });
        }

        // Función para validar teléfono
        function validarTelefono(telefono) {
            const telefonoLimpio = telefono.replace(/[^\d+]/g, '');
            return telefonoLimpio.startsWith('+') && telefonoLimpio.length >= 12;
        }

        // Función para validar contraseña
        function validarPassword(password) {
            return password.length >= 6;
        }

        // Función para enviar código de verificación
        async function enviarCodigo() {
            usuario.nombre = document.getElementById("nombre").value.trim();
            usuario.telefono = document.getElementById("telefono").value.trim();
            usuario.password = document.getElementById("password").value.trim();

            if (!validarTelefono(usuario.telefono)) {
                showStatus("Ingresa un número válido con código de país (ej. +521234567890).", true);
                return false;
            }

            if (!validarPassword(usuario.password)) {
                showStatus("La contraseña debe tener al menos 6 caracteres.", true);
                return false;
            }

            showStatus("Enviando código de verificación...");

            try {
                const response = await fetch('https://mapsapi-27zu.onrender.com/send-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phoneNumber: usuario.telefono,
                        nombre: usuario.nombre
                    })
                });

                if (!response.ok) throw new Error(await response.text());

                const data = await response.json();
                if (data.success) {
                    showStatus("Código enviado. Revisa tu teléfono.");
                    usuario.verificationId = data.verificationId || '';
                    return true;
                } else {
                    throw new Error(data.message || "Error al enviar el código");
                }
            } catch (error) {
                showStatus("Error: " + error.message, true);
                return false;
            }
        }

        // Función para verificar código
        async function verificarCodigo() {
            const codigo = document.getElementById("codigoVerificacion").value.trim();
            if (!codigo || codigo.length < 6) {
                showStatus("Ingresa el código de 6 dígitos.", true);
                return null;
            }

            showStatus("Verificando código...");

            try {
                const response = await fetch('https://mapsapi-27zu.onrender.com/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phoneNumber: usuario.telefono,
                        code: codigo,
                        verificationId: usuario.
