<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Tijuana con Marcadores Dinámicos</title>
    <!-- Hojas de estilo actualizadas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.awesome-markers@2.0.2/dist/leaflet.awesome-markers.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f7fa;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        #map {
            width: 100%;
            max-width: 900px;
            height: 60vh;
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #e8f4fd;
            color: #31708f;
            text-align: center;
            width: 100%;
            max-width: 900px;
        }
        #listaUbicaciones {
            width: 100%;
            max-width: 900px;
            max-height: 25vh;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        #listaUbicaciones h3 {
            margin-top: 0;
            color: #34495e;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        #lista {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #lista li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }
        #lista li:last-child {
            border-bottom: none;
        }
        #botonUbicacion {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #botonUbicacion:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        #botonUbicacion:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Mapa de Tijuana con Marcadores Dinámicos</h1>
    <p id="status">Cargando sistema de ubicaciones...</p>
    <button id="botonUbicacion">
        <i class="fas fa-map-marker-alt"></i> Guardar Mi Ubicación Actual
    </button>
    <div id="map"></div>
    <div id="listaUbicaciones">
        <h3><i class="fas fa-list"></i> Ubicaciones Registradas</h3>
        <ul id="lista"></ul>
    </div>
    <div id="loader" class="loader"></div>

    <!-- Scripts actualizados -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.awesome-markers@2.0.2/dist/leaflet.awesome-markers.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.3/firebase-database.js"></script>

    <script>
        // Coordenadas de Tijuana (centro del mapa)
        const CENTRO_TIJUANA = [32.5149, -117.0382];
        const ZOOM_INICIAL = 13;
        let marcadorCentral;

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBbR-O6hqk9gN2ohQuCCmV-vHiaEGhAL8s",
            authDomain: "construyecercadeti.firebaseapp.com",
            databaseURL: "https://construyecercadeti-default-rtdb.firebaseio.com",
            projectId: "construyecercadeti",
            storageBucket: "construyecercadeti.appspot.com",
            messagingSenderId: "888808949632",
            appId: "1:888808949632:web:677961b72573979c1b6365",
            measurementId: "G-METG6NS3ZC"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Obtener el ID de usuario del localStorage
        const userId = localStorage.getItem("userId");
        const statusElement = document.getElementById("status");
        
        if (userId) {
            statusElement.innerHTML = `<i class="fas fa-user-circle"></i> Usuario ID: ${userId}`;
        } else {
            statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Usuario no identificado. <a href="index.html">Regístrese aquí</a>';
            document.getElementById("botonUbicacion").disabled = true;
        }

        // Crear iconos personalizados para diferentes tipos de usuarios
        const iconos = {
            cliente: L.AwesomeMarkers.icon({
                icon: 'user',
                prefix: 'fa',
                markerColor: 'blue',
                iconColor: 'white',
                extraClasses: 'animate__animated animate__pulse'
            }),
            administrador: L.AwesomeMarkers.icon({
                icon: 'star',
                prefix: 'fa',
                markerColor: 'red',
                iconColor: 'white'
            }),
            tecnico: L.AwesomeMarkers.icon({
                icon: 'tools',
                prefix: 'fa',
                markerColor: 'green',
                iconColor: 'white'
            }),
            default: L.AwesomeMarkers.icon({
                icon: 'map-marker-alt',
                prefix: 'fa',
                markerColor: 'orange',
                iconColor: 'white'
            })
        };

        // Inicializar el mapa centrado en Tijuana
        const map = L.map('map').setView(CENTRO_TIJUANA, ZOOM_INICIAL);

        // Añadir capa base de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);

        // Marcador para el centro de Tijuana
        marcadorCentral = L.marker(CENTRO_TIJUANA, {
            icon: L.AwesomeMarkers.icon({
                icon: 'flag',
                prefix: 'fa',
                markerColor: 'purple',
                iconColor: 'white'
            }),
            zIndexOffset: 1000
        }).addTo(map)
        .bindPopup("<b><i class='fas fa-flag'></i> Tijuana</b><br>Centro de la ciudad")
        .openPopup();

        // Función para determinar el tipo de usuario
        function getTipoUsuario(userId) {
            if (!userId) return 'default';
            const lastDigit = parseInt(userId.slice(-1));
            if (lastDigit % 3 === 0) return 'administrador';
            if (lastDigit % 2 === 0) return 'tecnico';
            return 'cliente';
        }

        // Cargar ubicaciones del usuario actual
        if (userId) {
            database.ref("ubicaciones/" + userId).once("value", (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const tipo = getTipoUsuario(userId);
                    L.marker([data.latitud, data.longitud], {
                        icon: iconos[tipo] || iconos.default
                    }).addTo(map)
                    .bindPopup(`<b><i class='fas fa-user'></i> Tu ubicación</b><br>${data.nombre || 'Usuario'} (${tipo})<br><small>${data.timestamp || ''}</small>`)
                    .openPopup();
                }
            }).catch(error => {
                console.error("Error al cargar ubicación:", error);
                statusElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error al cargar ubicación: ${error.message}`;
            });
        }

        // Cargar todas las ubicaciones
        function cargarUbicaciones() {
            showLoader(true);
            const lista = document.getElementById("lista");
            lista.innerHTML = "<li>Cargando ubicaciones...</li>";

            database.ref("ubicaciones").on("value", (snapshot) => {
                // Limpiar marcadores existentes (excepto el marcador central)
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer !== marcadorCentral) {
                        map.removeLayer(layer);
                    }
                });

                lista.innerHTML = "";
                
                if (!snapshot.exists()) {
                    lista.innerHTML = "<li>No hay ubicaciones registradas</li>";
                    showLoader(false);
                    return;
                }

                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    const nombre = data.nombre || "Usuario " + childSnapshot.key;
                    const latitud = data.latitud;
                    const longitud = data.longitud;
                    const timestamp = data.timestamp || "Fecha desconocida";
                    const tipo = getTipoUsuario(childSnapshot.key);

                    // Añadir marcador al mapa con icono personalizado
                    L.marker([latitud, longitud], {
                        icon: iconos[tipo] || iconos.default
                    }).addTo(map)
                    .bindPopup(`<b><i class='fas fa-${tipo === 'administrador' ? 'star' : 'tools'}'></i> ${nombre}</b><br>Tipo: ${tipo}<br><small>${timestamp}</small>`);

                    // Añadir ubicación a la lista
                    const li = document.createElement("li");
                    li.innerHTML = `${nombre} <span>(${tipo})</span> - ${timestamp}`;
                    lista.appendChild(li);
                });

                showLoader(false);
            });
        }

        // Función para mostrar el indicador de carga
        function showLoader(show) {
            document.getElementById("loader").style.display = show ? "block" : "none";
        }

        // Configurar evento para guardar la ubicación del usuario
        document.getElementById("botonUbicacion").addEventListener("click", () => {
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta geolocalización.");
                return;
            }

            showLoader(true);
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const timestamp = new Date().toISOString();
                const tipo = getTipoUsuario(userId);

                // Guardar la ubicación en Firebase
                database.ref("ubicaciones/" + userId).set({
                    latitud: lat,
                    longitud: lon,
                    nombre: "Ubicación del usuario",
                    timestamp: timestamp
                }).then(() => {
                    statusElement.innerHTML = "<i class='fas fa-check'></i> Ubicación guardada.";
                    cargarUbicaciones(); // Cargar ubicaciones después de guardar
                }).catch((error) => {
                    statusElement.innerHTML = "<i class='fas fa-exclamation-circle'></i> Error al guardar la ubicación.";
                    showLoader(false);
                    console.error(error);
                });
            }, (error) => {
                alert("Error al obtener la ubicación: " + error.message);
                showLoader(false);
            });
        });

        // Cargar ubicaciones cada vez que se inicia la página
        cargarUbicaciones();
    </script>
</body>
</html>
